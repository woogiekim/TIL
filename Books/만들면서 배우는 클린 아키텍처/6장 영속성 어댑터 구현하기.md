# 영속성 어댑터 구현하기

## 의존성 역전

- 애플리케이션 서비스에서는 영속성 기능을 사용하기 위해 포트 인터페이스를 호출한다.
- 이 포트는 실제로 영속성 작업을 수행하고 데이터베이스와 통신할 책임을 가진 영속성 어댑터 클래스에 의해 구현된다.


- 육각형 아키텍처에서 영속성 어댑터는 '주도되는' 혹은 '아웃고잉' 어댑터다.
- 애플리케이션에 의해 호출될 뿐, 애플리케이션을 호출하지는 않기 때문이다.


- 포트는 사실상 애플리케이션 서비스와 영속성 코드 사이의 간접적인 계층이다.
- 영속성 계층에 대한 코드 의존성을 없애기 위해 이러한 간접 계층을 추가하고 있다는 사실을 잊지 말자.
- 이렇게 되면 영속성 코드를 리팩토링하더라도 코어 코드를 변경하는 결과로 이어지지 않을 것이다.


- 예를들어, 영속성 계층의 코드를 변경하는 중에 코드가 생기면 애플리케이션 코어의 기능은 망가질 것이다.
- 하지만 포트가 계약을 만족하는 한, 코어에 영향을 미치지 않으면서 영속성 코드를 마음껏 수정할 수 있다.

## 영속성 어댑터의 책임

1. 입력을 받는다.
2. 입력을 데이터베이스 포맷으로 매핑한다.
3. 입력을 데이터베이스로 보낸다.
4. 데이터베이스 출력을 애플리케이션 포맷으로 매핑한다.
5. 출력을 반환한다.

- JPA나 다른 객체-관계 매핑 프레임워크 대신, 데이터베이스와 통신하기 위해 어떤 기술을 사용해도 상관없다.
- 입력 모델을 평범한 SQL 구문에 매핑해서 데이터베이스에 보내도 되고, 들어오는 데이터를 파일로 직렬화해서 그것으로부터 데이터를 읽어와도 된다.


- 핵심은 영속성 어댑터의 입력 모델이 영속성 어댑터 내부에 있는 것이 아니라 애플리케이션 코어에 있기 때문에 영속성 어댑터 내부를 변경하는 것이 코어에 영향을 미치지 않는다는 것이다.


## 포트 인터페이스 나누기

- 특정 엔티티가 필요로 하는 모든 데이터베이스 연산을 하나의 리포지토리 인터페이스에 넣어 두는 게 일반적인 방법이다.
- 그럼 데이터베이스 연산에 의존하는 각 서비스는 인터페이스에서 단 하나의 메소드만 사용하더라도 하나의 '넓은' 포트 인터페이스에 의존성을 갖게 된다.
- 코드에 불필요한 의존성이 생겼다는 뜻이다.

> 필요없는 화물을 운반하는 무언가에 의존하고 있으면 예상하지 못했던 문제가 생길 수 있다. - 로버트 C. 마틴

- 인터페이스 분리 원칙은 이 문제의 답을 제시한다.
- 이 원칙은 클라이언트가 오로지 자신이 필요로 하는 메소드만 알면 되도록 넓은 인터페이스를 특화된 인터페이스로 분리해야 한다고 설명한다.


- 매우 좁은 포트를 만드는 것은 코딩을 플러그 앤드 플레이 경험으로 만든다.
- 서비스 코드를 짤 때는 필요한 포트에 그저 '꽂기만'하면 된다. 운반할 다른 화물이 없는 것이다.
- 물론 모든 상황에 '포트 하나당 하나의 메소드'를 적용하지는 못할 것이다.
- 응집성이 높고 함께 사용될 때가 많기 때문에 하나의 인터페이스에 묶고 싶은 데이터베이스 연산들이 있을 수 있다.


## 영속성 어댑터 나누기

- '애그리것당 하나의 영속성 어댑터' 접근 방식 또한 나중에 여러개의 바운디드 컨텍스트의 영속성 요구사항을 분리하기 위한 좋은 토대가 된다.
- 각 바운디드 컨텍스트는 영속성 어댑터를 하나씩(하나 이상일 수도 있다) 가지고 있다.
- '바운디드 컨텍스트'라는 표현은 경계를 암시한다.
- account 맥락의 서비스가 billing 맥락의 영속성 어댑터에 접근하지 ㅇ낳고, 반대로 billing의 서비스도 account의 영속성 어댑터에 접근하지 않는다는 의미다.
- 어떤 맥락이 다른 맥락에 있는 무엇인가를 필요로 한다면 전용 인커밍 포트를 통해 접근해야 한다.


## 유지보수 가능한 소프트웨어를 만드는 데 어떻게 도움이 될까?

- 도메인 코드에 플러그인처럼 영속성 어댑터를 만들면 도메인 코드가 영속성과 관련된 것들로부터 분리되어 풍부한 도메인 모델을 만들 수 있다.
- 좁은 포트 인터페이스를 사용하면 포트마다 다른 방식으로 구현할 수 있는 유연함이 생긴다. 심지어 포트 뒤에서 애플리케이션이 모르게 다른 영속성 기술을 사용할 수도 있다.
- 포트의 명세만 지켜진다면 영속성 계층 전체를 교체할 수도 있다.