# 리팩토링

- TDD에서는 리팩토링을 특이한 방법으로 사용한다.
- 일반적으로 리팩토링은 어떤 상황에서도 프로그램의 읨론을 변경해서는 안 된다.
- 하지만 TDD에서 우리가 신경 쓰는 부분은 현재 이미 통과한 테스트들뿐이다.
- 예를 들어 TDD에서는 상수를 변수로 바꾸고 양심에 꺼리낌 없이 이를 리팩토링이라고 한다.
- 왜냐하면 이 행위가 통과하는 테스트의 집합에 아무 변화도 주지 않기 떄문이다.
- 의미론이 유지되는 상황이란 사실 태스트 케이스 하나일 수도 있다.
- 그럴 떄 이전에 통과한 다른 테스트 케이스들은 실패하게 될 것이다.
- 하지만 우린 아직 나머지 테스트를 만들지 않았기 때문에 이 테스트들에 대해서는 걱정할 필요가 없다.
- 이 '관측상의 동치성'이 성립되려면 충분한 테스트를 가지고 있어야 한다.
- 여기에서 충분한 테스트란, 현재 가지고 있는 테스트들에 기반한 리팩토링이 추측 가능한 모든 테스트에 기반한 리팩토링과 동일한 것으로 여겨질 수 있는 상태를 말한다.
- "문제가 있다는 건 알지만 테스트는 모두 통과하니까 일단 CVS에 체크인 해야지."하고 말할 수는 없다.
- 만약 그런 생각이 든다면 테스트를 더 만들어야 한다.

## 차이점 일치시키기

- 비슷해 보이는 두 코드 조각을 하빛려면 어떻게 해야 할까?
- 두 코드가 단계적으로 닮아가게끔 수정한다.
- 이 둘이 완전히 동일해지면 둘을 합친다.
- 우리가 작은 단계와 명확한 피드백을 이용해서 피해가고자 하는 일이 바로, 불확실한 믿음에 의지하여 단계를 크게 건더뛰는 리팩토링이다.
- 물로 이런 크게 도약하는 리팩토링을 완전히 피할 수는 없겠지만, 발생 빈도를 줄일 수는 있다.
  - 두 반복문의 구조가 비슷하다. 이 둘을 동일하게 만드록 나서 하나로 합친다.
  - 조건문에 의해 나눠지는 두 분기의 코드가 비슷하다. 이 둘을 동일하게 만들고 나서 조건문을 제거한다.
  - 두 클래스가 비슷하다. 이 둘을 동일하게 만들고 나서 하나를 제거한다.
- 간혹 차이점 일치시키기를 거꾸로 수행해야 하는 경우도 있다.
- 이 말은, 변경 마지막 단계에 사소한 것만 처리하게 하려면 어떤 모양새가 되어야 할까 생각한 다음 거꾸로 거슬러 온다는 것이다.
- 예를 들어 여러 개의 하위 클래스를 제거하길 원한다고 치자. 하위 클래스의 내용이 비어 있다면 마지막 작업은 간단할 것이다.
- 그러면 단지 하위 클래스에 대한 참조를 상위 클래스로 바꿔주기만 하면 된다.
- 이 작업은 시스템 행위를 변경하지 않을 것이다.
- 하위 클래스의 내용이 비어 있으면 메소드의 내용이 상위 클래스의 메소드 내용과 동일하면 된다.
- 하나씩 하나씩 하위 클래스의 내용을 비우고, 모두 비게 되면 하위 클래스에 대한 참조를 상위 클래스로 바꾼다.

## 변화 격리하기